/*
 * This file was generated by the Gradle 'init' task.
 *
 * This project uses @Incubating APIs which are subject to change.
 */

plugins {
    id "java"
    id "monticore" version "$mc_version"
    id "maven-publish"
}

def junit_version = '4.13.1'
def freemarker_version = '2.3.32' // Freemarker gradle template needs this parameter. Needs to be deleted after fix
def grammarDir = file("$projectDir/src/main/grammars/")

group = "mc-scolar"
version = '1.0.1-SNAPSHOT'
description = 'helper-languages'
sourceCompatibility = "11"

buildDir = file("$projectDir/target")

sourceSets {
    main.java.srcDirs += ["$buildDir/generated-sources/monticore/sourcecode"]
    grammars {
        resources {
            srcDirs([grammarDir])
            include "**/*.mc4"
        }
    }
}

dependencies {
    implementation "scolar:language-family-tool:$scolar_core_version"
    implementation "scolar:language-component-tool:$scolar_core_version"
    implementation "scolar:customization-interface-tool:$scolar_core_version"
    implementation "scolar:customization-interface-tool:$scolar_core_version"
    implementation "scolar:customization-interface-tool:$scolar_core_version"
    implementation "scolar:mc-language-component-tool:$scolar_core_version"


    implementation group: 'org.freemarker', name: 'freemarker', version: '2.3.32'

    implementation group: 'org.apache.commons', name: 'commons-lang3', version: '3.14.0'
    implementation "de.se_rwth.commons:se-commons-logging:$se_commons_version"
    implementation "de.se_rwth.commons:se-commons-utilities:$se_commons_version"
    implementation group: 'de.monticore.lang', name: 'cd4analysis', version: mc_version
    grammar("de.monticore.lang:cd4analysis:$mc_version") {
        capabilities {
            requireCapability("de.monticore.lang:cd4analysis-grammars")
        }
    }
    implementation 'de.monticore:javaDSL:7.5.0'
    implementation group: 'de.monticore.lang', name: 'cd4analysis', version: mc_version
    testImplementation group: 'junit', name: 'junit', version: junit_version
    testImplementation("de.monticore:monticore-runtime:$mc_version") {
        capabilities {
            requireCapability("de.monticore:monticore-runtime-tests")
        }
    }
}

task generate {}

fileTree(grammarDir).matching { include '**/*.mc4' }.each { g ->
    def taskname = "generateGrammar${g.getName().substring(0,g.getName().lastIndexOf('.'))}"

    task "$taskname" (type: MCTask) {
        grammar = g
        outputDir = file "$buildDir/generated-sources/monticore/sourcecode"
        def grammarIncludingPackage = file(grammarDir).toURI().relativize(g.toURI()).toString()
        outputs.upToDateWhen { incCheck(grammarIncludingPackage) }
    }
    generate.dependsOn ("$taskname")
}

compileJava {
    dependsOn project.collect { it.tasks.withType(MCTask) }
}

java {
    withSourcesJar()
    registerFeature('grammars') {
        usingSourceSet(sourceSets.grammars)
    }
}

sourcesJar.dependsOn project.collect { it.tasks.withType(MCTask) }

tasks.withType(JavaCompile) {
    options.encoding = 'UTF-8'
}

// configure deployment
publishing {
    // configure what artifacts to publish
    publications {
        scolar(MavenPublication) {
            artifactId = "$project.name"
            from components.java
        }
    }
}

task buildAll(type: GradleBuild) {
    ext.message = 'buildAll'
    tasks = ['build']
}

// generated java doc contains errors, disable for now
javadoc.failOnError(false)

defaultTasks 'build'